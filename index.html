<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="logo.ico" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <title>FrankServices</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Serif:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <!-- jsPDF para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    window.jsPDF = window.jspdf.jsPDF;
  </script>

</head>

<body>
  <div class="container">
    <div class="header">
      <img src="logo.jpeg" alt="Logo" class="logo" />
      <div class="titulo">
        <h1>FrankServices</h1>
        <p class="subtitulo">üìã Formulario de ingreso de reparaciones</p>
      </div>
    </div>


    <form id="form-reparacion" class="formulario">
      <h3><i class="fas fa-user"></i> Datos del Cliente</h3>

      <div class="form-grupo">
        <label for="nombre">Nombre del Cliente</label>
        <input type="text" id="nombre" placeholder="Ej: Juan P√©rez" required />
      </div>

      <div class="form-grupo">
        <label for="dni">DNI</label>
        <input type="text" id="dni" placeholder="Ej: 12345678" required />
      </div>

      <div class="form-grupo">
        <label for="telefono">Tel√©fono</label>
        <input type="tel" id="telefono" placeholder="Ej: 2984000000" required />
      </div>

      <h3><i class="fas fa-mobile-alt"></i> Datos del Dispositivo</h3>

      <div class="form-grupo">
        <label for="tipo">Tipo de equipo</label>
        <input type="text" id="tipo" placeholder="Ej: Celular, Tablet" required />
      </div>

      <div class="form-grupo">
        <label for="marca">Marca</label>
        <input type="text" id="marca" placeholder="Ej: Samsung, Xiaomi" required />
      </div>

      <div class="form-grupo">
        <label for="modelo">Modelo</label>
        <input type="text" id="modelo" placeholder="Ej: A52, Redmi 9" required />
      </div>

      <div class="form-grupo">
        <label for="serial">Serial</label>
        <input type="text" id="serial" placeholder="Ej: SN123456789" />
      </div>

      <div class="form-grupo">
        <label for="tipoReparacion">Tipo de reparaci√≥n</label>
        <input type="text" id="tipoReparacion" placeholder="Ej: Cambio de pantalla" />
      </div>

      <div class="form-grupo">
        <label for="falla">Falla reportada</label>
        <input type="text" id="falla" placeholder="Ej: No enciende" />
      </div>

      <div class="form-grupo">
        <label for="estadoGeneral">Estado general</label>
        <input type="text" id="estadoGeneral" placeholder="Ej: Golpeado en una esquina" />
      </div>

      <div class="form-grupo">
        <label for="accesorios">Accesorios entregados</label>
        <input type="text" id="accesorios" placeholder="Ej: Cargador, funda" />
      </div>

      <div class="form-grupo">
        <label for="contrasena">Contrase√±a del dispositivo</label>
        <input type="text" id="contrasena" placeholder="Ej: 1234, patr√≥n, etc." />
      </div>


      <div class="form-grupo">
        <label for="costo">Costo Aproximado ($)</label>
        <input type="number" id="costo" step="0.01" placeholder="Ej: 3500" />
      </div>

      <div class="solo-mobile" style="text-align: center; margin-top: 20px;">
        <a href="firma.html" class="btn-firma">
          <i class="fas fa-signature"></i> Firmar digitalmente
        </a>
      </div>

      <div class="estado-container">
        <label><i class="fas fa-tools"></i> Estado de la reparaci√≥n</label>
        <div class="checkbox-group">
          <label class="radio-card">
            <input type="radio" name="estadoReparacion" value="Ingresado" checked />
            <i class="fas fa-sign-in-alt icono"></i>
            Ingresado
          </label>

          <label class="radio-card">
            <input type="radio" name="estadoReparacion" value="Entregado" />
            <i class="fas fa-box"></i>
            Entregado
          </label>
        </div>
      </div>

      <div class="boton-centrado">
        <button type="submit" id="btn-guardar">Guardar</button>
      </div>


      <div class="estadisticas">
        <h2><i class="fas fa-chart-bar"></i> Estad√≠sticas</h2>

        <div class="stats-grid">
          <div class="stat-card">
            <i class="fas fa-screwdriver-wrench icon"></i>
            <p>Total reparaciones</p>
            <span id="total-reparaciones">0</span>
          </div>

          <div class="stat-card">
            <i class="fas fa-dollar-sign icon"></i>
            <p>Total facturado</p>
            <span id="total-facturado">$0.00</span>
          </div>

          <div class="stat-card">
            <i class="fas fa-box-open icon"></i>
            <p>Entregadas</p>
            <span id="entregadas">0</span>
          </div>

          <div class="stat-card">
            <i class="fas fa-clock icon"></i>
            <p>Pendientes</p>
            <span id="pendientes">0</span>
          </div>
        </div>
      </div>
    </form>

    <hr>

    <div class="busqueda-container">
      <h2><i class="fas fa-user-search"></i> B√∫squeda de Cliente</h2>

      <div class="busqueda-box">
        <input type="text" id="busqueda" placeholder="Buscar por DNI..." />
        <button onclick="toggleReparaciones()">
          <i class="fas fa-eye"></i> Ver/Ocultar Reparaciones
        </button>
      </div>

      <!-- ‚úÖ MENSAJE VA AQU√ç -->
      <div id="mensaje-error" class="mensaje-oculto">‚ùå Cliente no encontrado</div>
    </div>
    <div id="lista-reparaciones" class="oculto"></div>
  </div>

  <button id="btn-top" title="Volver arriba">
    <i class="fas fa-arrow-up"></i>
  </button>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDYPxGjUU2X2APsRcMMhDbwTOASL72wx-0",
      authDomain: "reparacion-celulares.firebaseapp.com",
      projectId: "reparacion-celulares",
      storageBucket: "reparacion-celulares.appspot.com",
      messagingSenderId: "858487731820",
      appId: "1:858487731820:web:e6e4d4d78ae0c7c5928a49"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let idParaEditar = null;
    const form = document.getElementById('form-reparacion');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const datos = {
        cliente: {
          nombre: document.getElementById('nombre').value,
          dni: document.getElementById('dni').value,
          telefono: document.getElementById('telefono').value
        },
        dispositivo: {
          tipo: document.getElementById('tipo').value,
          marca: document.getElementById('marca').value,
          modelo: document.getElementById('modelo').value,
          serial: document.getElementById('serial').value,
          tipoReparacion: document.getElementById('tipoReparacion').value,
          falla: document.getElementById('falla').value,
          estadoGeneral: document.getElementById('estadoGeneral').value,
          accesorios: document.getElementById('accesorios').value,
          contrasena: document.getElementById('contrasena').value,
          estado: document.querySelector('input[name="estadoReparacion"]:checked').value,
          costo: parseFloat(document.getElementById('costo').value)
        },
        fecha: new Date()
      };

      try {
        if (idParaEditar) {
          await db.collection('reparaciones').doc(idParaEditar).update(datos);
          alert('Reparaci√≥n actualizada ‚úÖ');
          idParaEditar = null;
        } else {
          await db.collection('reparaciones').add(datos);
          alert('Reparaci√≥n guardada ‚úÖ');
        }

        form.reset();
      } catch (error) {
        console.error("Error: ", error);
        alert('Error al guardar ‚ùå');
      }
    });

    function renderReparaciones(snapshot) {
      let coincidencias = 0;
      const lista = document.getElementById("lista-reparaciones");
      const dniBuscar = document.getElementById("busqueda").value.toLowerCase();
      lista.innerHTML = "";

      snapshot.forEach((doc) => {
        const data = doc.data();
        const id = doc.id;
        const dni = data.cliente.dni.toLowerCase();

        if (!dniBuscar || dni.includes(dniBuscar)) {
          coincidencias++;
          const fecha = parseFecha(data.fecha);
          const item = document.createElement("div");
          item.classList.add("tarjeta");

          item.innerHTML = `
      <strong>Cliente:</strong> ${data.cliente.nombre} (${data.cliente.telefono})<br>
      <strong>DNI:</strong> ${data.cliente.dni}<br>
      <strong>Equipo:</strong> ${data.dispositivo.tipo}, ${data.dispositivo.marca} ${data.dispositivo.modelo}<br>
      <strong>Serial:</strong> ${data.dispositivo.serial}<br>
      <strong>Tipo de reparaci√≥n:</strong> ${data.dispositivo.tipoReparacion}<br>
      <strong>Falla:</strong> ${data.dispositivo.falla}<br>
      <strong>Estado general:</strong> ${data.dispositivo.estadoGeneral}<br>
      <strong>Accesorios:</strong> ${data.dispositivo.accesorios}<br>
      <strong>Contrase√±a:</strong> ${data.dispositivo.contrasena ? data.dispositivo.contrasena : 'Sin contrase√±a'}<br>
      <strong>Estado:</strong> ${data.dispositivo.estado}<br>
      <strong>Costo:</strong> $${data.dispositivo.costo?.toFixed(2) || "0.00"}<br>
      <strong>Fecha:</strong> ${fecha.toLocaleString()}<br><br>
      <button onclick="editarReparacion('${id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">Editar</button>
      <button onclick="eliminarReparacion('${id}')">Eliminar</button>
      <button onclick="descargarPDF(${JSON.stringify(data).replace(/"/g, '&quot;')})">PDF</button>
      <button onclick="enviarWhatsApp(${JSON.stringify(data).replace(/"/g, '&quot;')})">WhatsApp</button>
    `;
          lista.appendChild(item);
        }
      });

      const mensaje = document.getElementById("mensaje-error");

      mensaje.style.display = "none";

      if (dniBuscar && coincidencias === 0) {
        mensaje.textContent = "‚ùå Cliente no encontrado";
        mensaje.style.display = "block";

        setTimeout(() => {
          mensaje.style.display = "none";
        }, 3000);
      }
    }

    db.collection("reparaciones").onSnapshot((snapshot) => {
      renderReparaciones(snapshot);
      cargarEstadisticas();
    });

    document.getElementById("busqueda").addEventListener("input", () => {
      db.collection("reparaciones").onSnapshot(renderReparaciones);
    });

    function eliminarReparacion(id) {
      if (confirm("¬øEst√°s seguro de eliminar esta reparaci√≥n?")) {
        db.collection("reparaciones").doc(id).delete()
          .then(() => alert("Reparaci√≥n eliminada ‚úÖ"))
          .catch((error) => alert("No se pudo eliminar ‚ùå"));
      }
    }

    function editarReparacion(id, data) {
      document.getElementById('nombre').value = data.cliente.nombre;
      document.getElementById('dni').value = data.cliente.dni;
      document.getElementById('telefono').value = data.cliente.telefono;
      document.getElementById('tipo').value = data.dispositivo.tipo;
      document.getElementById('marca').value = data.dispositivo.marca;
      document.getElementById('modelo').value = data.dispositivo.modelo;
      document.getElementById('serial').value = data.dispositivo.serial;
      document.getElementById('tipoReparacion').value = data.dispositivo.tipoReparacion;
      document.getElementById('falla').value = data.dispositivo.falla;
      document.getElementById('estadoGeneral').value = data.dispositivo.estadoGeneral;
      document.getElementById('accesorios').value = data.dispositivo.accesorios;
      document.getElementById('contrasena').value = data.dispositivo.contrasena || '';
      document.getElementById('costo').value = data.dispositivo.costo;

      const estadoRadios = document.querySelectorAll('input[name="estadoReparacion"]');
      estadoRadios.forEach(radio => {
        radio.checked = (radio.value === data.dispositivo.estado);
      });

      idParaEditar = id;
      alert("Editando reparaci√≥n. Guarda los cambios para actualizar.");
    }

    function toggleReparaciones() {
      document.getElementById("lista-reparaciones").classList.toggle("oculto");
    }

    function cargarEstadisticas() {
      db.collection("reparaciones").get().then((snapshot) => {
        let total = 0;
        let totalFacturado = 0;
        let entregadas = 0;
        let pendientes = 0;

        snapshot.forEach(doc => {
          const data = doc.data();
          total++;
          totalFacturado += data.dispositivo.costo || 0;

          if (data.dispositivo.estado === "Entregado") {
            entregadas++;
          } else {
            pendientes++;
          }
        });

        document.getElementById("total-reparaciones").textContent = total;
        document.getElementById("total-facturado").textContent = totalFacturado.toFixed(2);
        document.getElementById("entregadas").textContent = entregadas;
        document.getElementById("pendientes").textContent = pendientes;
      });
    }

    async function getImageBase64(url) {
      try {
        const res = await fetch(url);
        const blob = await res.blob();
        return await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      } catch (error) {
        console.error("Error cargando imagen:", error);
        return null;
      }
    }

    async function descargarPDF(data) {
      const doc = new jsPDF();
      const logo = await getImageBase64("logo.jpeg");

      if (logo) {
        doc.addImage(logo, "JPEG", 15, 10, 30, 30);
      }

      doc.setFontSize(18);
      doc.text("FrankServices - Ficha de Reparaci√≥n", 50, 20);

      doc.setFontSize(12);
      doc.text("Frank P√©rez ¬∑ Tlf: 2984230332 ¬∑ Villa Regina. Argentina", 50, 28);

      doc.setFontSize(14);
      let y = 50;
      const salto = 9;

      const fecha = parseFecha(data.fecha);
      const fechaFormateada = fecha.toLocaleDateString('es-AR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      doc.text(`Cliente: ${data.cliente.nombre}`, 20, y); y += salto;
      doc.text(`DNI: ${data.cliente.dni}`, 20, y); y += salto;
      doc.text(`Tel√©fono: ${data.cliente.telefono}`, 20, y); y += salto;
      doc.text(`Equipo: ${data.dispositivo.tipo} - ${data.dispositivo.marca} ${data.dispositivo.modelo}`, 20, y); y += salto;
      doc.text(`Serial: ${data.dispositivo.serial}`, 20, y); y += salto;
      doc.text(`Tipo de Reparaci√≥n: ${data.dispositivo.tipoReparacion}`, 20, y); y += salto;
      doc.text(`Falla Reportada: ${data.dispositivo.falla}`, 20, y); y += salto;
      doc.text(`Estado General: ${data.dispositivo.estadoGeneral}`, 20, y); y += salto;
      doc.text(`Accesorios: ${data.dispositivo.accesorios}`, 20, y); y += salto;
      doc.text(`Contrase√±a: ${data.dispositivo.contrasena || "Sin contrase√±a"}`, 20, y); y += salto;
      doc.text(`Estado: ${data.dispositivo.estado}`, 20, y); y += salto;
      doc.text(`Costo: $${data.dispositivo.costo.toFixed(2)}`, 20, y); y += salto;
      doc.text(`Fecha: ${fechaFormateada}`, 20, y); y += salto + 5;

      doc.setFontSize(11);
      const nota = "Nota: El cliente queda debidamente informado que el presupuesto dado es por la falla reportada y por el tipo de reparaci√≥n al momento de recibir el dispositivo a reparar. Cualquier otro desperfecto encontrado en el dispositivo por el t√©cnico, ser√° informado al cliente para la aprobaci√≥n de la reparaci√≥n o cambio, indicando el valor adicional si fuera el caso.";
      const notaPartes = doc.splitTextToSize(nota, 170);
      doc.text(notaPartes, 20, y); y += notaPartes.length * 6 + 15;

      doc.setFontSize(13);
      doc.text("Firma del Cliente:", 20, y); y += salto;

      const firma = localStorage.getItem("firmaCliente");
      if (firma) {
        doc.addImage(firma, 'PNG', 20, y, 60, 30);
        y += 35;
      } else {
        doc.text("_________________________", 20, y);
        y += 10;
      }

      doc.save(`Ficha-${data.cliente.nombre}-${data.cliente.dni}.pdf`);
    }
    function enviarWhatsApp(data) {
      const numeroDestino = prompt("¬øA qu√© n√∫mero quieres enviar el WhatsApp? (ej: 1123456789)");
      if (!numeroDestino) return;

      const fecha = parseFecha(data.fecha);

      const mensaje = `
*FRANK SERVICES - DETALLES DE REPARACI√ìN*

‚úÖ *Cliente:* ${data.cliente.nombre}
üÜî *DNI:* ${data.cliente.dni}
üì≤ *Tel√©fono:* ${data.cliente.telefono}

üì± *Equipo:* ${data.dispositivo.tipo} - ${data.dispositivo.marca} ${data.dispositivo.modelo}
üõ† *Reparaci√≥n:* ${data.dispositivo.tipoReparacion}
‚ö† *Falla:* ${data.dispositivo.falla}
üéí *Accesorios:* ${data.dispositivo.accesorios}
üîí *Contrase√±a:* ${data.dispositivo.contrasena || "Sin contrase√±a"}
üîÑ *Estado:* ${data.dispositivo.estado}
üíµ *Costo:* $${data.dispositivo.costo.toFixed(2)}
üìÖ *Fecha:* ${fecha.toLocaleDateString('es-AR')}

_¬°Gracias por confiar en nosotros!_`;

      const telefono = numeroDestino.replace(/\D/g, '');
      const url = `https://wa.me/549${telefono}?text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
    }

    function parseFecha(fecha) {
      if (fecha && typeof fecha.toDate === 'function') {
        return fecha.toDate();
      }
      if (fecha instanceof Date) {
        return fecha;
      }
      if (typeof fecha === 'string') {
        return new Date(fecha);
      }
      if (typeof fecha === 'number') {
        return new Date(fecha);
      }
      return new Date();
    }

    const btnTop = document.getElementById("btn-top");

    window.addEventListener("scroll", () => {
      if (window.scrollY > 300) {
        btnTop.style.display = "block";
      } else {
        btnTop.style.display = "none";
      }
    });

    btnTop.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
    
  </script>

</body>

</html>